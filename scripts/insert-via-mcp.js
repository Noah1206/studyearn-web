/**
 * Generate individual SQL INSERT statements for MCP execution
 * Output: One INSERT per school for manual MCP execution
 */
const fs = require('fs');
const path = require('path');

const schools = require('./schools-with-coords.json');

// Existing neis_codes in DB (already inserted 444 + 50 = 494)
const existingCodes = new Set(["7130165","7041164","7130166","7031261","7132123","7130167","7130168","7121341","7130268","7081484","7130169","7132124","7041165","7121342","7041166","7091420","7091421","7130170","7134119","7081485","7031179","7134120","7061094","7091422","7041167","7134121","7021122","7021123","7130171","7121358","7121359","7041168","7051174","7081487","7132125","7134122","7031180","7132126","7134123","7051175","7134124","7134125","7134126","7041169","7091423","7031181","7132127","7134127","7041170","7132128","7081488","7061095","7121357","7041171","7132129","7132130","7121360","7132131","7132132","7091486","7051176","7051177","7051178","7051179","7091449","7132133","7041172","7041173","7061096","7021124","7041174","7091424","7132134","7031182","7061097","7041175","7091425","7134130","7091426","7091427","7031183","7061098","7061099","7081516","7091428","7051180","7121361","7134161","7021125","7021126","7091450","7031184","7134129","7031185","7130172","7061100","7130173","7132135","7021127","7041176","7132136","7130174","7081489","7081490","7081517","7081515","7081540","7134131","7081518","7021128","7081519","7130175","7031186","7081491","7081492","7081493","7134132","7041177","7041178","7041179","7130176","7132137","7130177","7132138","7091429","7091430","7130178","7081494","7130179","7051181","7081495","7130180","7061101","7130181","7061102","7081496","7051182","7121344","7061103","7130182","7130183","7132139","7081520","7132140","7091431","7021129","7051183","7121345","7031187","7051184","7132141","7121346","7121347","7132142","7081497","7051185","7051186","7051187","7132143","7061104","7051188","7021130","7031188","7031189","7051189","7130275","7132144","7121362","7091451","7031190","7091432","7061129","7121371","7132145","7031191","7130185","7091433","7091434","7121348","7130186","7051190","7061105","7041180","7031192","7031193","7132146","7130187","7130188","7132147","7031194","7031195","7031196","7134134","7121363","7061106","7121364","7134135","7021131","7081498","7091461","7130189","7041181","7091452","7121380","7021211","7130190","7081499","7130191","7051191","7081500","7091435","7121349","7121350","7091453","7121370","7031197","7031198","7132148","7021133","7041182","7132149","7061108","7091436","7041263","7081501","7041183","7051192","7031199","7091437","7132150","7130192","7081502","7091438","7051193","7091439","7051194","7081503","7031200","7130193","7134136","7031201","7081504","7081505","7121365","7081521","7051195","7130194","7021134","7081506","7130195","7031202","7041184","7091440","7081507","7081508","7081509","7081522","7134137","7081510","7041185","7091441","7091442","7091443","7041186","7091444","7031203","7031204","7031205","7031206","7031207","7081511","7051196","7081512","7041187","7081523","7091445","7132151","7031208","7021135","7041188","7041189","7041190","7130196","7121369","7031209","7130197","7041191","7041192","7130198","7061110","7130199","7134138","7051197","7061111","7134139","7021136","7121351","7061112","7041193","7021137","7091446","7051198","7121352","7081513","7130271","7041194","7091454","7031210","7051199","7091447","7031211","7121353","7031212","7031213","7132152","7134140","7130201","7130279","7130202","7132153","7021138","7061113","7121354","7061114","7021139","7051200","7021140","7021141","7021142","7130203","7031214","7051201","7021143","7121355","7051202","7091455","7021144","7031215","7132154","7031216","7061115","7051203","7051204","7021145","7031217","7031218","7091456","7061116","7051205","7121366","7051206","7051207","7031219","7041238","7130204","7130205","7091448","7021146","7061117","7051208","7031220","7051209","7021147","7130206","7130207","7051210","7061118","7130208","7121367","7031221","7134141","7061119","7130209","7041195","7051212","7041262","7130256","7134142","7021148","7031222","7031223","7121368","7121356","7081524","7081514","7061120","7051213","7021149","7021150","7091457","7010057","7011169","7010117","7010118","7010958","7010058","7010119","7010059","7010271","7010272",
// Batch 1 (just inserted)
"7010060","7010061","7010120","7010062","7010835","7010122","7010124","7010125","7010563","7010698","7010126","7010127","7011312","7010797","7011487","7010063","7010064","7010065","7010066","7010131","7010132","7010133","7011488","7010067","7010134","7010135","7011505","7010068","7011111","7010069","7010827","1371661","1371663","7010071","7010072","7011319","7010136","7010564","7010589","7011489","7010137","7010073","7011507","7010138","7010833","7010139","7010140","7010074","7010141","7010142"
]);

const newSchools = schools.filter(s => !existingCodes.has(s.sd_schul_code));

console.log(`Remaining schools to insert: ${newSchools.length}`);

// Generate SQL for batch with 100 schools
function generateSqlBatch(batch) {
  const values = batch.map(s => {
    const name = s.name.replace(/'/g, "''");
    const address = (s.address || '').replace(/'/g, "''");
    const district = (s.district || '').replace(/'/g, "''");
    const highSchoolType = s.high_school_type && s.high_school_type.trim() ? `'${s.high_school_type.trim()}'` : 'NULL';
    const foundationType = s.foundation_type ? `'${s.foundation_type}'` : 'NULL';
    const coeduType = s.coedu_type ? `'${s.coedu_type}'` : 'NULL';

    return `('${name}', '${s.type}', '${s.region}', '${district}', '${address}', ${s.latitude}, ${s.longitude}, '${s.sd_schul_code}', '${s.atpt_ofcdc_sc_code}', ${highSchoolType}, ${foundationType}, ${coeduType}, ST_SetSRID(ST_MakePoint(${s.longitude}, ${s.latitude}), 4326)::geography)`;
  }).join(',\n  ');

  return `INSERT INTO schools (name, type, region, district, address, latitude, longitude, neis_code, edu_office_code, high_school_type, foundation_type, coedu_type, location)
VALUES
  ${values};`;
}

// Generate batches of 100
const BATCH_SIZE = 100;
const outputDir = path.join(__dirname, 'sql-batches-new');
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir);
}

for (let i = 0; i < newSchools.length; i += BATCH_SIZE) {
  const batch = newSchools.slice(i, i + BATCH_SIZE);
  const batchNum = Math.floor(i / BATCH_SIZE) + 1;
  const sql = generateSqlBatch(batch);

  fs.writeFileSync(
    path.join(outputDir, `batch-${String(batchNum).padStart(3, '0')}.sql`),
    sql
  );
}

const totalBatches = Math.ceil(newSchools.length / BATCH_SIZE);
console.log(`Generated ${totalBatches} batches in ${outputDir}/`);
